{"version":3,"file":"helpers.js","sources":["../../../src/cli/helpers.js","@traceur/generated/TemplateParser/4","@traceur/generated/TemplateParser/0","@traceur/generated/TemplateParser/6","@traceur/generated/TemplateParser/5","@traceur/generated/TemplateParser/1","@traceur/generated/TemplateParser/2"],"names":[],"mappings":"AAAA;ACAI,CAAJ,EAAI,CAAA,YAAY,oBAAoB,CAAC;UCArC,CAAA,OAAO,CFAmB,KAAK,CEAL;;;;YAA1B,CAAA,OAAO,CFCgB,kBAAkB,CEDf;qBAA1B,CAAA,OAAO,CFEyB,kBAAkB,CEFxB;AFItB,CAAJ,EAAI,CAAA,KAAK,EAAG,CAAA,CAAC,CAAC,oCAAoC,CAAC,CAAC;AAChD,CAAJ,EAAI,CAAA,KAAK,EAAG,CAAA,CAAC,CAAC,kCAAkC,CAAC,CAAC;AAC9C,CAAJ,EAAI,CAAA,QAAQ,EAAG;AACX,CAAA,SAAQ,CAAE,IAAG;AACb,CAAA,WAAU,CAAE,IAAG;AACf,CAAA,MAAK,CAAE,GAAE;AACT,CAAA,MAAK,CAAE,IAAG;CAAA,AACb,CAAA;AAEG,CAAJ,EAAI,CAAA,OAAO,EAAG;CACZ,gBAAe,CAAf,UAAgB,GAAG;CACjB,oBAAQ,KAAK;CACX,SAAI,CAAC,KAAK;CAAE,cAAO;AAEf,CAFe,QAEf,CAAA,OAAO,EAAG,CAAA,KAAK,QAAQ,GAAI,QAAO,CAAA;AAClC,CAAJ,QAAI,CAAA,IAAI,EAAM,EAAC,QAAQ,CAAE,QAAO,CAAC,CAAC;CAElC,aAAO,KAAK,KAAK;CACf,WAAK,SAAQ;CAEX,iBAAO,KAAK,OAAO;CACjB,eAAK,cAAa,CAAC;CACnB,eAAK,UAAS;AACZ,CAAA,gBAAG,KAAK,CG3BtB,eAAe,OAAO,CH2BK,IAAI,GAAE,KAAK,OAAO,EG3BJ,CH2BO,CAAA,KAAK,KAAK,CAAC,CAAC;CAC9C,mBAAM;AACR,CADQ,eACH,QAAO;AACV,CAAA,gBAAG,KAAK,CG9BtB,eAAe,OAAO,CH8BK,IAAI,GAAE,KAAK,OAAO,EG9BJ,CH8BO,MAAK,CAAC,CAAC;CACzC,mBAAM;AACR,CADQ;CAEN,iBAAI,KAAK,OAAO,GAAI,WAAU,CAAE;AAC9B,CAAA,kBAAG,QAAQ,CGlC3B,eAAe,OAAO,CHkCU,IAAI,GAAE,MAAM,EGlCH,CHkCM,CAAA,KAAK,KAAK,CAAC,CAAC;eAC5C;AACD,CADC,gBACE,GAAG,CGpCpB,eAAe,OAAO,CHoCG,IAAI,GAAG,KAAK,OAAO,EGpCH,CHoCM,CAAA,KAAK,KAAK,CAAC,CAAC;CAJvC,UAKT;CACD,eAAM;AACR,CADQ,WACH,cAAa;AACZ,CAAJ,YAAI,CAAA,IAAI,EGxClB,CAAA,eAAe,OAAO,CHwCG,IAAI,GAAE,UAAU,EGxCA,AHwCC,CAAC;AACjC,CAAA,YAAG,OAAO,CAAC,IAAI,CAAE,MAAK,CAAC,CAAC;AACxB,CAAA,YAAG,GAAG,CAAC,IAAI,CAAE,MAAK,CAAC,CAAC;CACpB,eAAM;AACR,CADQ,WACH,MAAK;CACR,aAAI,OAAO,GAAI,SAAQ;CACrB,iBAAM;AACV,CADU;AAER,CAAA,YAAG,MAAM,CAAC,KAAK,CAAC,CAAC;CADX,MAET;OACD;GACH;CAED,aAAY,CAAZ,UAAa;CACX,SAAO,CAAA,MAAM,OAAO,EAAE,KAAK,WAAE,MAAM,CAAK;CACtC,SAAI,CAAC,MAAM,MAAM,CAAE;CACjB,YAAM,IAAI,gBAAe,EAAE,CAAC;OAC7B;CAAA,IACF,EAAC,CAAC;GACJ;CAED,gBAAe,CAAf,UAAgB,GAAG;AACb,CAAJ,MAAI,CAAA,KAAK,EAAG,CAAA,GAAG,aAAa,EAAE,CAAC;AAC3B,CAAJ,MAAI,CAAA,IAAI,EAAI,GAAE,CAAC;CAEf,oBAAQ,KAAK,CAAK;CAChB,SAAI,KAAK,KAAK,GAAI,WAAU,CAAA,EAAI,EAAC,KAAK,GAAG;CAAE,aAAO,MAAK,CAAC;AAEpD,CAFoD,QAEpD,CAAA,MAAM,EAAG,CAAA,KAAK,aAAa,CAAC;AAC5B,CAAJ,QAAI,CAAA,KAAK,IAAO,KAAK,GAAG,EAAA,IAAG,CAAA,CAAC;AACxB,CAAJ,QAAI,CAAA,GAAG,EAAM,CAAA,IAAI,CAAC,KAAK,GAAG,CAAC,GAAI,CAAA,GAAG,OAAO,CAAC,KAAK,CAAE,MAAK,CAAE,SAAQ,CAAC,CAAC;CAElE,aAAO,MAAM,KAAK;CAChB,WAAK,WAAU;AACT,CAAJ,YAAI,CAAA,QAAQ,EAAG,CAAA,KAAK,eAAe,CAAC;AAChC,CAAJ,YAAI,CAAA,IAAI,EAAO,CAAA,QAAQ,QAAQ,EAAG,CAAA,GAAG,KAAK,CAAC;AAC3C,CAAA,YAAG,MAAM,EAAM,CAAA,QAAQ,MAAM,EAAG,EAAC,CAAC;AAClC,CAAA,YAAG,KAAK,CAAC,IAAI,CAAE;AAAE,CAAA,gBAAK,CAAL,MAAK;AAAE,CAAA,mBAAQ,CAAE,CAAA,KAAK,SAAS;CAAA,UAAE,CAAC,CAAC;CACpD,eAAM;AACR,CADQ;AAEN,CAAA,YAAG,KAAK,CAAC,GAAG,KAAK,CAAE;AAAE,CAAA,gBAAK,CAAL,MAAK;AAAE,CAAA,cAAG,CAAE,MAAK;AAAE,CAAA,cAAG,CAAE,CAAA,KAAK,OAAO;CAAA,UAAE,CAAC,CAAC;CADvD,MAET;AAED,CAAA,SAAI,CAAC,KAAK,GAAG,CAAC,EAAG,IAAG,CAAC;CAErB,WAAO,MAAK,CAAC;KACd,EAAA;GACF;CAED,cAAa,CAAb,UAAc,QAAQ;AAEhB,CAAJ,MAAI,CAAA,YAAY,EAAG,MAAK,CAAC;AACrB,CAAJ,MAAI,CAAA,MAAM,EAAG,MAAK,CAAC;CAEnB,oBAAQ,KAAK,CAAK;CAChB,SAAI,KAAK,KAAK,GAAI,aAAY,CAAE;AAC1B,CAAJ,UAAI,CAAA,KAAK,EAAI,CAAA,KAAK,KAAK,CAAC,CAAC,CAAC,MAAM,CAAC;AAC7B,CAAJ,UAAI,CAAA,MAAM,EAAG,CAAA,KAAK,KAAK,CAAC,CAAC,CAAC,OAAO,CAAC;AAC9B,CAAJ,UAAI,CAAA,SAAS,EAAG,CAAA,KAAK,GAAG,CAAC;AACrB,CAAJ,UAAI,CAAA,OAAO,EAAG,MAAK,CAAC;AAEpB,CAAA,YAAK,GAAG,CAAC,MAAM,CAAE,UAAU,GAAG,CAAE;CAC9B,aAAI,OAAO;CAAE,iBAAO,MAAK,CAAC;AAEtB,CAFsB,YAEtB,CAAA,EAAE,EAAG,CAAA,GAAG,SAAS,CAAC,KAAK,SAAS,GAAI,QAAO,CAAC,CAAC;CAEjD,aAAI,YAAY,GAAI,CAAA,EAAE,IAAK,IAAG,CAAE;AAC9B,CAAA,uBAAY,EAAG,MAAK,CAAC;AACrB,CAAA,iBAAM,EAAG,KAAI,CAAC;WACf,KAAM,KAAG,EAAE,IAAK,KAAI,CAAE;AACrB,CAAA,uBAAY,EAAG,KAAI,CAAC;AACpB,CAAA,iBAAM,MAAM,CAAC,GAAG,CAAC,CAAC;WACnB,KAAM;CACL,eAAI,MAAM,CAAE;AACV,CAAA,oBAAO,EAAG,CAAA,QAAQ,CAAC,EAAE,CAAE,UAAS,CAAC,CAAC;AAClC,CAAA,mBAAM,EAAG,MAAK,CAAC;aAChB,KAAM;AACL,CAAA,mBAAM,MAAM,CAAC,GAAG,CAAC,CAAC;aACnB;AACD,CADC,uBACW,EAAG,MAAK,CAAC;WACtB;CAAA,QACF,CAAC,CAAC;OACJ;AACD,CADC,WACM,KAAI,CAAC;KACb,EAAA;GACF;CACF,CAAA;;AI9HD,CAAA,KAAM,QAAQ;CCAd,cAAwB;CAAE,kBAAyB;GAAE;ACArD,CAAA,WAAU,CAAE,KAAI;CAAA,AFAkB,CAAC;CJiInC","sourcesContent":["import { _, t, log } from 'azk';\nimport { Client } from 'azk/agent/client';\nimport { AgentNotRunning } from 'azk/utils/errors';\n\nvar fmt_p = t('commands.helpers.pull.bar_progress');\nvar fmt_s = t('commands.helpers.pull.bar_status');\nvar bar_opts = {\n    complete: '='\n  , incomplete: ' '\n  , width: 30\n  , total: 100\n}\n\nvar Helpers = {\n  vmStartProgress(cmd) {\n    return (event) => {\n      if (!event) return;\n\n      var context = event.context || \"agent\"\n      var keys    = [\"status\", context];\n\n      switch(event.type) {\n        case \"status\":\n          // running, starting, not_running, already\n          switch(event.status) {\n            case \"not_running\":\n            case \"already\":\n              cmd.fail([...keys, event.status], event.data);\n              break;\n            case \"error\":\n              cmd.fail([...keys, event.status], event);\n              break;\n            default:\n              if (event.status == \"starting\") {\n                cmd.warning([...keys, \"wait\"], event.data);\n              }\n              cmd.ok([...keys,  event.status], event.data);\n          }\n          break;\n        case \"try_connect\":\n          var tKey = [...keys, \"progress\"];\n          log.info_t(tKey, event);\n          cmd.ok(tKey, event);\n          break;\n        case \"ssh\":\n          if (context == \"stderr\")\n            break;\n        default:\n          log.debug(event);\n      }\n    };\n  },\n\n  requireAgent() {\n    return Client.status().then((status) => {\n      if (!status.agent) {\n        throw new AgentNotRunning();\n      }\n    });\n  },\n\n  newPullProgress(cmd) {\n    var mbars = cmd.newMultiBars();\n    var bars  = {};\n\n    return (event) => {\n      if (event.type != \"pull_msg\" || !event.id) return event;\n\n      var status = event.statusParsed;\n      var title  = `${event.id}:`;\n      var bar    = bars[event.id] || cmd.newBar(mbars, fmt_p, bar_opts);\n\n      switch(status.type) {\n        case 'download':\n          var progress = event.progressDetail;\n          var tick     = progress.current - bar.curr;\n          bar.total    = progress.total + 1;\n          bar.tick(tick, { title, progress: event.progress });\n          break;\n        default:\n          bar.tick(bar.curr, { title, fmt: fmt_s, msg: event.status });\n      }\n\n      bars[event.id] = bar;\n\n      return false;\n    }\n  },\n\n  escapeCapture(callback) {\n    // Escape sequence\n    var escapeBuffer = false;\n    var escape = false;\n\n    return (event) => {\n      if (event.type == \"stdin_pipe\") {\n        var stdin  = event.data[0].stdin;\n        var stream = event.data[0].stream;\n        var container = event.id;\n        var stopped = false;\n\n        stdin.on('data', function (key) {\n          if (stopped) return false;\n\n          var ch = key.toString(stdin.encoding || 'utf-8');\n\n          if (escapeBuffer && ch === '~') {\n            escapeBuffer = false;\n            escape = true;\n          } else if(ch === '\\r') {\n            escapeBuffer = true;\n            stream.write(key);\n          } else {\n            if (escape) {\n              stopped = callback(ch, container);\n              escape = false;\n            } else {\n              stream.write(key);\n            }\n            escapeBuffer = false;\n          }\n        });\n      }\n      return true;\n    }\n  }\n}\n\nexport { Helpers };\n","var __moduleName = $__placeholder__0;","require($__placeholder__0)","$traceurRuntime.spread($__placeholder__0)","module.exports = $__placeholder__0;","get $__placeholder__0() { return $__placeholder__1; }","__esModule: true"]}