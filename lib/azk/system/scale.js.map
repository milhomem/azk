{"version":3,"file":"scale.js","sources":["../../../src/system/scale.js","@traceur/generated/TemplateParser/4","@traceur/generated/TemplateParser/0","@traceur/generated/TemplateParser/14","@traceur/generated/TemplateParser/6","@traceur/generated/TemplateParser/13","@traceur/generated/TemplateParser/9","@traceur/generated/TemplateParser/7","@traceur/generated/TemplateParser/10","@traceur/generated/TemplateParser/8","@traceur/generated/TemplateParser/11","@traceur/generated/TemplateParser/12","@traceur/generated/TemplateParser/5","@traceur/generated/TemplateParser/1","@traceur/generated/TemplateParser/2"],"names":[],"mappings":"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","sourcesContent":["import { Q, async, _ } from 'azk';\nimport { SystemDependError, SystemNotScalable } from 'azk/utils/errors';\nimport { Balancer } from 'azk/system/balancer';\nimport docker from 'azk/docker';\n\nvar Scale = {\n  start(system, options = {}) {\n    return this.scale(system, system.default_instances, options);\n  },\n\n  scale(system, instances = {}, options = {}) {\n    // Default instances\n    if (_.isObject(instances)) {\n      options   = _.merge(instances, options);\n      instances = system.default_instances;\n    }\n\n    // Protect not scalable systems\n    if (!system.scalable && instances > 1) {\n      return Q.reject(new SystemNotScalable(system));\n    }\n\n    // Default options\n    options = _.defaults(options, {\n      envs: {},\n      dependencies: true,\n    });\n\n    return async(this, function* (notify) {\n      var deps_envs = yield this.checkDependsAndReturnEnvs(system, options);\n      options.envs  = _.merge(deps_envs, options.envs || {});\n\n      var containers = yield this.instances(system);\n      var from = containers.length;\n      var icc  = instances - from;\n\n      if (icc != 0)\n        notify({ type: \"scale\", from, to: from + icc, system: system.name });\n\n      if (icc > 0) {\n        for(var i = 0; i < icc; i++) {\n          yield system.runDaemon(_.clone(options));\n          options.provision_force = false;\n        }\n      } else if (icc < 0) {\n        containers = containers.reverse().slice(0, Math.abs(icc));\n        yield system.stop(containers, options);\n      }\n\n      return icc;\n    });\n  },\n\n  killAll(system, options = {}) {\n    return async(this, function* () {\n      options = _.defaults(options, {\n        kill: true,\n      });\n\n      // Clear balancer\n      yield Balancer.clear(system);\n\n      var instances = yield this.instances(system);\n      return system.stop(instances, options.kill);\n    });\n  },\n\n  _dependencies_options(options) {\n    return {\n      dependencies: options.dependencies,\n      pull: options.pull,\n    };\n  },\n\n  checkDependsAndReturnEnvs(system, options, required = true) {\n    var depends = system.dependsInstances;\n    return async(this, function* () {\n      var instances, depend, envs = {};\n\n      for (var d = 0; d < depends.length; d++) {\n        depend    = depends[d];\n        instances = yield this.instances(depend);\n        if (_.isEmpty(instances) && required) {\n          // Run dependencies\n          if (options.dependencies) {\n            yield depend.start(this._dependencies_options(options));\n            instances = yield this.instances(depend);\n          } else {\n            throw new SystemDependError(system.name, depend.name);\n          }\n        }\n\n        if (!_.isEmpty(instances)) {\n          envs = _.merge(envs, yield this.getEnvs(depend, instances));\n        }\n      }\n\n      return envs;\n    });\n  },\n\n  getEnvs(system, instances = null) {\n    return async(this, function* () {\n      var ports = {}, envs = {};\n      if (instances.length > 0) {\n        var data = yield docker.getContainer(instances[0].Id).inspect();\n        _.each(data.NetworkSettings.Access, (port) => {\n          ports[port.name] = port.port;\n        });\n        envs = system.expandExportEnvs({\n          envs: this._parseEnvs(data.Config.Env),\n          net: { port: ports }\n        });\n      }\n      return envs;\n    });\n  },\n\n  _parseEnvs(collection) {\n    return _.reduce(collection, (envs, env) => {\n      if (env.match(/\\=/)) {\n        env = env.split(\"=\");\n        envs[env[0]] = env[1];\n      }\n      return envs;\n    }, {});\n  },\n\n  instances(system, options = {}) {\n    return system.instances(_.defaults(options, {\n      type: \"daemon\",\n    }));\n  },\n}\n\nexport { Scale };\n","var __moduleName = $__placeholder__0;","require($__placeholder__0)","return $__placeholder__0(\n            $__placeholder__1,\n            this);","$traceurRuntime.generatorWrap","function($ctx) {\n      while (true) $__placeholder__0\n    }","return $__placeholder__0","$ctx.sent","$ctx.state = ($__placeholder__0) ? $__placeholder__1 : $__placeholder__2;\n        break","$ctx.maybeThrow()","$ctx.returnValue = $__placeholder__0","return $ctx.end()","module.exports = $__placeholder__0;","get $__placeholder__0() { return $__placeholder__1; }","__esModule: true"]}