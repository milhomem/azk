{"version":3,"file":"index.js","sources":["../../../src/system/index.js","@traceur/generated/TemplateParser/4","@traceur/generated/TemplateParser/0","@traceur/generated/TemplateParser/6","@traceur/generated/TemplateParser/7","@traceur/generated/TemplateParser/8","@traceur/generated/TemplateParser/9","@traceur/generated/TemplateParser/5","@traceur/generated/TemplateParser/1","@traceur/generated/TemplateParser/2"],"names":[],"mappings":"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","sourcesContent":["import { _, t, config, path, async, Q, fs, utils } from 'azk';\nimport { Image } from 'azk/images';\nimport { net } from 'azk/utils';\nimport { XRegExp } from 'xregexp';\n\nimport { Run } from 'azk/system/run';\nimport { Scale } from 'azk/system/scale';\nimport { Balancer } from 'azk/system/balancer';\n\nvar regex_port = new XRegExp(\n  \"(?<private>[0-9]{1,})(:(?<public>[0-9]{1,})){0,1}(/(?<protocol>tcp|udp)){0,1}\", \"x\"\n);\n\nexport class System {\n  constructor(manifest, name, image, options = {}) {\n    this.manifest  = manifest;\n    this.name      = name;\n    this.image     = new Image(image);\n\n    // Options\n    this.__options = {}\n    this.options   = _.merge({}, this.default_options, options);\n    this.options   = this._expand_template(this.options);\n  }\n\n  set options(values) {\n    this.__options = values;\n  }\n\n  get options() {\n    return this.__options;\n  }\n\n  get default_options() {\n    return {\n      shell    : \"/bin/sh\",\n      depends  : [],\n      envs     : {},\n      scalable : false,\n    }\n  }\n\n  // System run operations\n  runShell(...args) { return Run.runShell(this, ...args); }\n  runDaemon(...args) { return Run.runDaemon(this, ...args); }\n  runProvision(...args) { return Run.runProvision(this, ...args); }\n  stop(...args) { return Run.stop(this, ...args); }\n  instances(...args) { return Run.instances(this, ...args); }\n  throwRunError(...args) { return Run.throwRunError(this, ...args); }\n\n  // Scale operations\n  start(...args) { return Scale.start(this, ...args); }\n  scale(...args) { return Scale.scale(this, ...args); }\n  killAll(...args) { return Scale.killAll(this, ...args); }\n  checkDependsAndReturnEnvs(...args) { return Scale.checkDependsAndReturnEnvs(this, ...args); }\n\n  // Save provision info\n  get provision_steps() {\n    var steps = this.options.provision || [];\n    if (!_.isArray(steps)) steps = [];\n    return steps;\n  }\n\n  get provisioned() {\n    var key  = this.name + \":provisioned\";\n    var date = this.manifest.getMeta(key);\n    return date ? new Date(date) : null;\n  }\n\n  set provisioned(value) {\n    var key  = this.name + \":provisioned\";\n    return this.manifest.setMeta(key, value);\n  }\n\n  // Options with default\n  get raw_command() { return this.options.command; }\n  get command() {\n    var command = this.options.command;\n    if (_.isEmpty(command)) {\n      var msg = t(\"system.cmd_not_set\", {system: this.name});\n      command = [this.shell, \"-c\", `echo \"${msg}\"; exit 1`];\n    } else {\n      command = [this.shell, \"-c\", command];\n    }\n\n    return command;\n  }\n\n  get workdir() {\n    return this.options.workdir || \"/\";\n  }\n\n  // Get options\n  get shell()             { return this.options.shell };\n  get raw_mount_folders() { return this.options.mount_folders };\n  get namespace() {\n    return this.manifest.namespace + '-sys.' + this.name;\n  }\n\n  // Scale options\n  get default_instances() {\n    return (this.options.scalable || {}).default || 1;\n  }\n  get scalable() {\n    return this.options.scalable ? true : false;\n  }\n  get wait_scale() {\n    var wait = this.options.wait;\n    return _.isEmpty(wait) && wait != false ? true : wait;\n  }\n\n  // Ports and host\n  get hostname() {\n    return (this.options.http || {}).hostname || config('agent:balancer:host');\n  }\n  get balanceable() {\n    var ports = this.ports;\n    return ports.http && (this.options.http || {}).hostname;\n  }\n\n  get url() {\n    var host = this.hostname;\n    var port = parseInt(config('agent:balancer:port'));\n    return `http://${host}${ port == 80 ? '' : ':' + port }`;\n  }\n\n  get hosts() { return [this.hostname]; }\n  backends() { return Balancer.list(this); }\n\n  get http_port() {\n    var ports = this._parse_ports(this.ports);\n    return ports.http.private;\n  }\n\n  portName(sought) {\n    var ports = this._parse_ports(this.ports);\n    var name  = sought;\n\n    _.each(ports, (port, port_name) => {\n      if (parseInt(sought) == parseInt(port.private)) {\n        name = port_name;\n      }\n    });\n\n    return name;\n  }\n\n  get ports() {\n    var ports = this.options.ports || {};\n\n    // Add http port\n    if (_.isEmpty(ports.http) && this.options.http) {\n      ports.http = \"5000/tcp\";\n    }\n\n    return ports;\n  }\n\n  // Envs\n  get envs() { return this.options.envs; }\n  expandExportEnvs(data) {\n    var ports, envs = {};\n\n    // Defaults options\n    data = _.defaults(data, { envs: {}, net: {}, });\n    data.net = _.defaults(data.net, { host: this.hostname, port: {}, });\n\n    // ports from instances\n    _.each(data.net.port, (port_public, port_private) => {\n      var key_port = (`${this.name}_${port_private}_PORT`).toUpperCase();\n      var key_host = (`${this.name}_${port_private}_HOST`).toUpperCase();\n      envs[key_port] = port_public;\n      envs[key_host] = data.net.host;\n    });\n\n    // ports from system ports options\n    ports = this._parse_ports(this.ports);\n    _.each(ports, (config, name) => {\n      var port     = data.net.port[config.private];\n      var key_port = (`${this.name}_${name}_PORT`).toUpperCase();\n      var key_host = (`${this.name}_${name}_HOST`).toUpperCase();\n      data.net.port[name] = port;\n      if (port && _.isEmpty(data.envs[key_port])) {\n        envs[key_port] = port;\n      }\n      if (_.isEmpty(data.envs[key_host])) {\n        envs[key_host] = data.net.host;\n      }\n    });\n\n    // http ports\n    var key = this.env_key('URL');\n    if (ports.http && _.isEmpty(envs[key])) {\n      envs[key] = `http://${data.net.host}`;\n    }\n\n    envs = _.reduce(this.options.export_envs || {}, (envs, value, key) => {\n      envs[key.toUpperCase()] = value;\n      return envs;\n    }, envs);\n\n    return JSON.parse(utils.template(JSON.stringify(envs), data));\n  }\n\n  env_key(...args) {\n    return (`${this.name}_${[...args].join(\"_\")}`).toUpperCase();\n  }\n\n  // Mounts options\n  get mounts() {\n    return this._mounts_to_volumes(this.options.mounts || {});\n  }\n\n  // Get depends info\n  get depends() { return this.options.depends };\n  get dependsInstances() {\n    return _.map(this.depends, (depend) => {\n      return this.manifest.system(depend, true);\n    });\n  };\n\n  // Docker run options generator\n  daemonOptions(options = {}) {\n    // Merge ports\n    options.ports = _.merge({}, this.ports, options.ports);\n\n    // Load configs from image\n    if (options.image_data) {\n      var config = options.image_data.Config;\n\n      // Cmd\n      if(_.isEmpty(this.options.command) && _.isEmpty(options.command)) {\n        options.command = config.Cmd;\n      }\n\n      // WorkingDir\n      if(_.isEmpty(this.options.workdir) && _.isEmpty(options.workdir)) {\n        options.workdir = config.WorkingDir;\n      }\n\n      // ExposedPorts\n      var ports = _.reduce(options.ports, (ports, value, key) => {\n        if (value == null) { value = `${key}/tcp`; }\n        ports[key] = value;\n        return ports;\n      }, {});\n\n      _.each(config.ExposedPorts, (_config, port) => {\n        var have = _.find(ports, (value, key) => {\n          return value.match(new RegExp(`${parseInt(port)}\\/(tcp|udp)$`));\n        });\n\n        if (!have) { options.ports[port] = port; }\n      });\n    }\n\n    // Clear null ports\n    options.ports = _.reduce(options.ports, (ports, value, key) => {\n      if (value != null) {\n        ports[key] = value;\n      }\n      return ports;\n    }, {});\n\n    return this._make_options(true, options);\n  }\n\n  shellOptions(options = {}) {\n    options = _.defaults(options, {\n      interactive: false,\n    });\n\n    var opts = this._make_options(false, options);\n\n    // Shell extra options\n    opts.annotations.azk.shell = (\n        options.shell_type ||\n        (options.interactive ? 'interactive' : 'script')\n    )\n    _.merge(opts, {\n      tty   : options.interactive ? options.stdout.isTTY : false,\n      stdout: options.stdout,\n      stderr: options.stderr || options.stdout,\n      stdin : options.interactive ? (options.stdin) : null,\n    });\n\n    return opts;\n  }\n\n  // Private methods\n  _make_options(daemon, options = {}) {\n    // Default values\n    options = _.defaults(options, {\n      workdir: this.options.workdir,\n      mounts: {},\n      envs: {},\n      ports: {},\n      sequencies: {},\n      docker: null,\n    });\n\n    // Map ports to docker configs: ports and envs\n    var envs  = _.merge({}, this.envs, this._envs_from_file(), options.envs);\n    var ports = {};\n    _.each(this._parse_ports(options.ports), (data, name) => {\n      if (!name.match(/\\//)) {\n        var env_key = `${name.toUpperCase()}_PORT`;\n        if (!envs[env_key]) envs[env_key] = data.private;\n      }\n      ports[data.name] = [data.config];\n    });\n\n    var type   = daemon ? \"daemon\" : \"shell\";\n    var mounts = _.merge(\n      {}, this.mounts,\n      this._mounts_to_volumes(options.mounts)\n    );\n\n    return {\n      daemon: daemon,\n      ports: ports,\n      stdout: options.stdout,\n      command: options.command || this.command,\n      volumes: mounts,\n      working_dir: options.workdir || this.workdir,\n      env: envs,\n      dns: net.nameServers(),\n      docker: options.docker || this.options.docker_extra || null,\n      annotations: { azk: {\n        type : type,\n        mid  : this.manifest.namespace,\n        sys  : this.name,\n        seq  : (options.sequencies[type] || 1),\n      }}\n    };\n  }\n\n  _envs_from_file() {\n    var envs = {};\n    var file = path.join(this.manifest.manifestPath, '.env');\n\n    if (fs.existsSync(file)) {\n      var content = fs.readFileSync(file).toString();\n      _.each(content.split('\\n'), (entry) => {\n        if (entry.match(/.*=.*/)) {\n          entry = entry.split('=');\n          envs[entry[0]] = entry[1];\n        }\n      });\n    }\n\n    return envs;\n  }\n\n  // Parse azk ports configs\n  _parse_ports(ports) {\n    return _.reduce(ports, (ports, port, name) => {\n      // skip disable\n      if (port == null) return ports;\n\n      port = XRegExp.exec(port, regex_port);\n      port.protocol = port.protocol || \"tcp\";\n\n      // TODO: Add support a bind ip\n      var conf = { HostIp: config(\"agent:dns:ip\") };\n      if (port.public)\n        conf.HostPort = port.public;\n\n      ports[name] = {\n        config : conf,\n        name   : port.private + \"/\" + port.protocol,\n        private: port.private\n      };\n      return ports;\n    }, {});\n  }\n\n  _expand_template(options) {\n    var data = {\n      _keep_key(key) {\n        return \"#{\" + key + \"}\";\n      },\n      system: {\n        name: this.name,\n        persistent_folders: \"/data\",\n      },\n      manifest: {\n        dir: this.manifest.manifestDirName,\n        path: this.manifest.manifestPath,\n        project_name: this.manifest.manifestDirName,\n      },\n      azk: {\n        default_domain: config('agent:balancer:host'),\n        balancer_port: config('agent:balancer:port'),\n        balancer_ip: config('agent:balancer:ip'),\n      }\n    };\n\n    var template = this._replace_keep_keys(JSON.stringify(options));\n    return JSON.parse(utils.template(template, data));\n  }\n\n  _replace_keep_keys(template) {\n    var regex = /(?:(?:[#|$]{|<%)[=|-]?)\\s*((?:envs|net)\\.[\\S]+?)\\s*(?:}|%>)/g;\n    return template.replace(regex, \"#{_keep_key('$1')}\");\n  }\n\n  _mounts_to_volumes(mounts) {\n    var volumes = {};\n\n    // support mount_folders\n    mounts = _.reduce(this.raw_mount_folders, (mounts, point, target) => {\n      mounts[point] = { type: 'path', value: target };\n      return mounts;\n    }, mounts);\n\n    // support persistent_folders\n    mounts = _.reduce(this.options.persistent_folders, (mounts, point) => {\n      mounts[point] = { type: 'persistent', value: path.join(this.name, point) };\n      return mounts;\n    }, mounts);\n\n    // persistent folder\n    var persist_base = config('paths:persistent_folders');\n    persist_base = path.join(persist_base, this.manifest.namespace);\n\n    return _.reduce(mounts, (volumes, mount, point) => {\n      if (_.isString(mount)) {\n        mount = { type: 'path', value: mount }\n      }\n\n      var target = null;\n      switch(mount.type) {\n        case 'path':\n          target = mount.value;\n          if (!target.match(/^\\//)) {\n            target = path.resolve(this.manifest.manifestPath, target);\n          }\n          target = (fs.existsSync(target)) ?\n            utils.docker.resolvePath(target) : null;\n          break;\n        case 'persistent':\n          target = path.join(persist_base, mount.value);\n          break;\n      }\n\n      if (!_.isEmpty(target)) {\n        volumes[point] = target;\n      }\n\n      return volumes;\n    }, volumes);\n  }\n}\n","var __moduleName = $__placeholder__0;","require($__placeholder__0)","var $__placeholder__0 = $__placeholder__1","($traceurRuntime.createClass)($__placeholder__0, $__placeholder__1, $__placeholder__2)","\n            for (var $__placeholder__0 = [], $__placeholder__1 = 0;\n                 $__placeholder__2 < arguments.length; $__placeholder__3++)\n              $__placeholder__4[$__placeholder__5] = arguments[$__placeholder__6];","$traceurRuntime.spread($__placeholder__0)","module.exports = $__placeholder__0;","get $__placeholder__0() { return $__placeholder__1; }","__esModule: true"]}