{"version":3,"file":"docker.js","sources":["../../../src/docker/docker.js","@traceur/generated/TemplateParser/4","@traceur/generated/TemplateParser/0","@traceur/generated/TemplateParser/7","@traceur/generated/TemplateParser/6","@traceur/generated/TemplateParser/9","@traceur/generated/TemplateParser/8","@traceur/generated/TemplateParser/11","@traceur/generated/TemplateParser/12","@traceur/generated/TemplateParser/10","@traceur/generated/TemplateParser/13","@traceur/generated/TemplateParser/5","@traceur/generated/TemplateParser/1","@traceur/generated/TemplateParser/2"],"names":[],"mappings":"AAAA;ACAI,CAAJ,EAAI,CAAA,YAAY,sBAAoB,CAAC;UCArC,CAAA,OAAO,CFAqC,KAAK,CEAvB;;;;;;;GFCnB,MAAK,EEDZ,CAAA,OAAO,CFCW,WAAW,CEDH;wBAA1B,CAAA,OAAO,CFE4B,oBAAoB,CEF7B;AFItB,CAAJ,EAAI,CAAA,IAAI,EAAG,CAAA,OAAO,CAAC,WAAW,CAAC,CAAC;UEJhC,CAAA,OAAO,CFOc,iBAAiB,CEPZ;SAA1B,CAAA,OAAO,CFQc,gBAAgB,CERX;ACAtB,CAAJ,EAAI,QHUG,SAAM,MAAK;AIVlB,CAAA,gBAAe,iBAAiB,CAAC,IAAI,CACrB,iBAA2B,CAAE,UAAS,CAAC,CAAA;CDDd,AHcxC,CGdwC;AEArC,CAAJ,EAAI,eAAqC,CAAA;ACAzC,CAAA,AAAC,eAAe,YAAY,CAAC,aNWpB,kBAAkB,CAAzB,UAA0B,AAAO;COVvB,QAAS,GAAA,OAAoB,GAAE;CAAE,aAAoB,EAAC,CACjD,OAAoB,CAAA,SAAS,OAAO,CAAE,OAAmB;AAC5D,CAAA,eAAoC,EAAG,CAAA,SAAS,MAAmB,CAAC;APS9E,COT8E,SPSvE,mBAAkB,YQZ7B,CAAA,eAAe,SAAS,CRYS,IAAI,CQZM,ERYJ;GACpC,EAHwB,CAAA,KAAK,KAAK,CAAC,qBAAqB,CAAC,CMTH;AHDrD,CAAJ,EAAI,YHgBG,SAAM,UAAS;AIhBtB,CAAA,gBAAe,iBAAiB,CAAC,IAAI,CACrB,qBAA2B,CAAE,UAAS,CAAC,CAAA;CDDd,AH2GxC,CG3GwC;AEArC,CAAJ,EAAI,uBAAqC,CAAA;ACAzC,CAAA,AAAC,eAAe,YAAY,CAAC;CNiB3B,IAAI,GAAE,EAAG;CACP,SAAO,CAAA,IAAI,GAAG,CAAC;GAChB;CAED,QAAO,CAAP,UAAQ,AAAO;COpBL,QAAS,GAAA,OAAoB,GAAE;CAAE,aAAoB,EAAC,CACjD,OAAoB,CAAA,SAAS,OAAO,CAAE,OAAmB;AAC5D,CAAA,eAAoC,EAAG,CAAA,SAAS,MAAmB,CAAC;APmB9E,COnB8E,SPmBvE,CStBX,eAAe,UAAU,uCCAzB,CAAA,eAAe,OAAO,CVsBF,IAAI,CUtBiB,CDCY,KTqBvB,WAAE,IAAI,CAAK;AACnC,CAAA,SAAI,YAAY,EAAG,CAAA,iCAAgC,CAAC,IAAI,KAAK,CAAC,CAAC;AAC/D,CAAA,SAAI,gBAAgB,EAAG,CAAA,gCAA+B,CAAC,IAAI,gBAAgB,CAAC,CAAC;CAC7E,WAAO,KAAI,CAAC;KACb,EAAC,CAAC;GACJ;;CAEM,WAAU,CAAjB,UAAkB,KAAK;CACrB,SAAO,CAAA,CAAC,OAAO,CAAC,KAAK,YAAG,KAAK,CAAE,CAAA,IAAI,CAAK;AACtC,CAAA,UAAK,CAAC,IAAI,YAAY,CAAC,EAAG;AACxB,CAAA,WAAI,CAAE,CAAA,IAAI,YAAY;AACtB,CAAA,eAAQ,CAAE,CAAA,IAAI,KAAK;AACnB,CAAA,cAAO,CAAE,CAAA,IAAI,GAAG;AAChB,CAAA,WAAI,CAAE,CAAA,IAAI,WAAW;CAAA,MACtB,CAAA;CACD,WAAO,MAAK,CAAC;KACd,EAAE,GAAE,CAAC,CAAC;GACR;CAEM,sBAAqB,CAA5B,UAA6B,OAAO;AAClC,CAAA,UAAO,OAAO,EAAG,GAAE,CAAC;AACpB,CAAA,IAAC,KAAK,CAAC,OAAO,MAAM,YAAG,IAAI,CAAE,CAAA,IAAI,CAAK;AACpC,CAAA,SAAI,EAAG,CAAA,IAAI,MAAM,CAAC,aAAa,CAAC,CAAC;CACjC,SAAI,IAAI,CAAE;AACR,CAAA,cAAO,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,EAAG;AACxB,CAAA,aAAI,CAAM,CAAA,IAAI,CAAC,CAAC,CAAC;AACjB,CAAA,iBAAQ,CAAE,CAAA,IAAI,CAAC,CAAC,CAAC;AACjB,CAAA,gBAAO,CAAG,CAAA,OAAO,QAAQ;AACzB,CAAA,aAAI,CAAM,CAAA,IAAI,CAAC,CAAC,CAAC,SAAS;CAAA,QAC3B,CAAC;OACH;CAAA,IACF,EAAC,CAAC;CACH,SAAO,QAAO,CAAC;GAChB;CAEM,YAAW,CAAlB,UAAmB,MAAM,CAAE;AACrB,CAAJ,MAAI,CAAA,KAAK,EAAG;AACV,CAAA,aAAQ,CAAE,EAAC;AACX,CAAA,WAAM,CAAG,CAAA,CAAC,MAAM,MAAM,CAAC,kBAAkB,CAAC,CAAC,EAAG,KAAI,EAAG,MAAK;AAC1D,CAAA,YAAO,CAAE,CAAA,CAAC,MAAM,MAAM,CAAC,KAAK,CAAC,CAAC,EAAG,KAAI,EAAG,MAAK;CAAA,IAC9C,CAAA;CAGD,OAAI,MAAM,MAAM,CAAC,QAAQ,CAAC,CAAE;AAC1B,CAAA,UAAK,SAAS,EAAG,CAAA,QAAQ,CACvB,MAAM,QAAQ,CAAC,mBAAmB,CAAE,KAAI,CAAC,CAC1C,CAAC;KACH;AAED,CAFC,SAEM,MAAK,CAAC;GACd;CAGM,qBAAoB,CAA3B,UAA4B,AAAyB;OAAzB,YAAW,6CAAG,EAAE,GAAG,CAAE,GAAE,CAAE;AAC/C,CAAJ,MAAI,CAAA,GAAG,EAAG,CAAA,WAAW,IAAI,CAAC;CAG1B,OAAI,CAAC,GAAG,IAAI,CAAE;AACZ,CAAA,QAAG,IAAI,EAAG,CAAA,IAAI,GAAG,EAAE,QAAQ,CAAC,IAAI,CAAE,GAAE,CAAC,MAAM,CAAC,CAAC,CAAE,GAAE,CAAC,CAAC;KACpD;AAGD,CAHC,SAGM,CUpFX,eAAe,OAAO,EVoFV,MAAM,CAAC,kBAAkB,CAAC,EAAK,EAAC,CAAC,IAAI,CAAC,GAAG,YAAG,KAAK,CAAE,CAAA,GAAG,CAAK;CACjE,WAAO,CAAA,GAAG,EAAG,IAAG,CAAA,CAAG,MAAK,CAAC;KAC1B,EAAC,CAAC,CUtFkC,KVsF5B,CAAC,GAAG,CAAC,CAAC;GAChB;CAGM,uBAAsB,CAA7B,UAA8B,IAAI;AAChC,CAAA,OAAI,EAAG,CAAA,IAAI,QAAQ,CAAC,QAAQ,CAAE,KAAI,CAAC,CAAC;AAChC,CAAJ,MAAI,CAAA,IAAI,EAAG,CAAA,IAAI,MAAM,CAAC,GAAG,CAAC,CAAC;CAC3B,SAAO,CAAA,CAAC,OAAO,CAAC,IAAI,YAAG,WAAW,CAAE,CAAA,MAAM,CAAK;AACzC,CAAJ,QAAI,CAAA,SAAS,EAAG,CAAA,MAAM,MAAM,CAAC,GAAG,CAAC,CAAC;AAClC,CAAA,gBAAW,IAAI,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,EAAG,CAAA,SAAS,CAAC,CAAC,CAAC,CAAC;CAC7C,WAAO,YAAW,CAAC;KACpB,EAAE,EAAE,GAAG,CAAE,GAAE,CAAE,CAAC,CAAC;GACjB;CAEM,oBAAmB,CAA1B,UAA2B,AAAwB;OAAxB,YAAW,6CAAG,EAAE,GAAG,CAAE,GAAE,CAAC;CACjD,SAAO,CAAA,CAAC,OAAO,CAAC,WAAW,IAAI,YAAG,IAAI,CAAE,CAAA,KAAK,CAAE,CAAA,GAAG,CAAK;CACrD,SAAI,GAAG,GAAI,MAAK;AAAE,CAAA,UAAG,EAAG,MAAK,CAAC;AAC9B,CAD8B,SAC1B,EAAC,MAAO,EAAA,CAAA,GAAG,YAAY,EAAE,EAAG,EAAG,MAAK,CAAC;CACzC,WAAO,KAAI,CAAC;KACb,EAAE,GAAE,CAAC,CAAC;GACR;EA1F4B,CAAA,KAAK,KAAK,CAAC,yBAAyB,CAAC,CMfX;AHDrD,CAAJ,EAAI,SH6GG,SAAM,OAAM,CACL,IAAI,CAAE;AAChB,CAAA,IAAG,KAAK,CAAC,eAAe,CAAE,CAAA,IAAI,KAAK,CAAE,CAAA,IAAI,KAAK,CAAC,CAAC;AS/GpD,CTgHI,gBShHW,UAAU,0CTgHf,IAAI,ES/GuC,CT+GrC;AAEZ,CAAA,KAAI,QAAQ,EAAG,CAAA,MAAM,EAAC,IAAK,EAAA,CAAA,KAAK,aAAa,CAAC,MAAM,CAAC,kBAAkB,CAAC,CAAC,EAAG,CAAC;CGlHxC,AHmHtC,CGnHsC;AEArC,CAAJ,EAAI,iBAAqC,CAAA;ACAzC,CAAA,AAAC,eAAe,YAAY,CAAC;CNqH3B,SAAQ,CAAR,UAAS,IAAI,CAAE;CACb,SAAO,IAAI,MAAK,CAAC,IAAI,MAAM,CAAE,KAAI,CAAC,CAAC;GACpC;CAED,aAAY,CAAZ,UAAa,EAAE,CAAE;CACf,SAAO,IAAI,UAAS,CAAC,IAAI,MAAM,CAAE,GAAE,CAAC,CAAC;GACtC;CAED,UAAS,CAAT,UAAU,GAAG;CACX,SAAO,CAAA,GAAG,QAAQ,EAAE,KAAK,WACtB,KAAK,CAAK;CAAE,WAAO,IAAG,CAAC;KAAE,aACzB,GAAG,CAAO;CACT,SAAI,GAAG,WAAW,GAAI,IAAG;CACvB,aAAO,KAAI,CAAC;AACd,CADc,UACR,IAAG,CAAC;KACX,EACF,CAAC;GACH;CAED,kBAAiB,CAAjB,UAAkB,AAAO;;COvIf,QAAS,GAAA,OAAoB,GAAE;CAAE,aAAoB,EAAC,CACjD,OAAoB,CAAA,SAAS,OAAO,CAAE,OAAmB;AAC5D,CAAA,eAAoC,EAAG,CAAA,SAAS,MAAmB,CAAC;CAAA;CPsI9E,SAAO,CAAA,OAAA,KAAI,4BQzIf,CAAA,eAAe,SAAS,CRyIU,IAAI,CQzIK,MRyIC,WAAE,UAAU;CAClD,WAAO,CAAA,CAAC,OAAO,CAAC,UAAU,YAAG,MAAM,CAAE,CAAA,SAAS,CAAK;CACjD,WAAI,SAAS,MAAM,CAAC,CAAC,CAAC,MAAM,CAAC,YAAY,CAAC,CAAE;AAC1C,CAAA,kBAAS,KAAK,EAAG,CAAA,SAAS,MAAM,CAAC,CAAC,CAAC,CAAC;AACpC,CAAA,kBAAS,YAAY,EAAG,CAAA,SAAS,uBAAuB,CAAC,SAAS,KAAK,CAAC,CAAC;AACzE,CAAA,kBAAS,MAAM,EAAG,CAAA,SAAS,YAAY,CAAC,SAAS,OAAO,CAAC,CAAC;AAC1D,CAAA,kBAAS,gBAAgB,EAAG,EAAE,MAAM,CAAE,CAAA,SAAS,WAAW,CAAC,SAAS,MAAM,CAAC,CAAE,CAAC;AAC9E,CAAA,eAAM,KAAK,CAAC,SAAS,CAAC,CAAC;SACxB;AACD,CADC,aACM,OAAM,CAAC;OACf,EAAE,GAAE,CAAC,CAAC;OACP,CAAC;GACJ;CAED,UAAS,CAAT,UAAU,IAAI,CAAE;CACd,SAAO,CAAA,IAAI,UAAU,CAAC,IAAI,SAAS,CAAC,IAAI,CAAC,CAAC,CAAC;GAC5C;CAED,cAAa,CAAb,UAAc,EAAE,CAAE;CAChB,SAAO,CAAA,IAAI,UAAU,CAAC,IAAI,aAAa,CAAC,EAAE,CAAC,CAAC,CAAC;GAC9C;CAED,KAAI,CAAJ,UAAK,AAAO;CO9JF,QAAS,GAAA,OAAoB,GAAE;CAAE,aAAoB,EAAC,CACjD,OAAoB,CAAA,SAAS,OAAO,CAAE,OAAmB;AAC5D,CAAA,eAAoC,EAAG,CAAA,SAAS,MAAmB,CAAC;AP6J9E,CO7J8E,SP6JvE,KAAI,YUhKf,CAAA,eAAe,OAAO,EVgKN,IAAI,EAAK,KAAI,CUhKY,EVgKV;GAC5B;CAED,IAAG,CAAH,UAAI,AAAO;COlKD,QAAS,GAAA,OAAoB,GAAE;CAAE,aAAoB,EAAC,CACjD,OAAoB,CAAA,SAAS,OAAO,CAAE,OAAmB;AAC5D,CAAA,eAAoC,EAAG,CAAA,SAAS,MAAmB,CAAC;APiK9E,COjK8E,SPiKvE,IAAG,YUpKd,CAAA,eAAe,OAAO,EVoKP,IAAI,CAAE,UAAS,EAAK,KAAI,CUpKE,EVoKA;GACtC;MAxDyB,CAAA,KAAK,KAAK,CAAC,WAAW,CAAC,CM5GM;AKDzD,CAAA,KAAM,QAAQ;CCAd,YAAwB;CAAE,gBAAyB;GAAE;CAArD,gBAAwB;CAAE,oBAAyB;GAAE;CAArD,aAAwB;CAAE,iBAAyB;GAAE;ACArD,CAAA,WAAU,CAAE,KAAI;CAAA,AFAkB,CAAC;CXuKnC","sourcesContent":["import { Q, pp, config, path, _, log } from 'azk';\nimport Utils from 'azk/utils';\nimport { parseRepositoryTag } from 'dockerode/lib/util';\n\nvar uuid = require('node-uuid');\n\n// Composer\nimport { pull } from 'azk/docker/pull';\nimport { run  } from 'azk/docker/run';\n\nexport class Image extends Utils.qify('dockerode/lib/image') {\n  static parseRepositoryTag(...args) {\n    return parseRepositoryTag(...args);\n  }\n}\n\nexport class Container extends Utils.qify('dockerode/lib/container') {\n  get Id() {\n    return this.id;\n  }\n\n  inspect(...args) {\n    return super(...args).then((data) => {\n      data.Annotations = Container.unserializeAnnotations(data.Name);\n      data.NetworkSettings = Container.parsePortsFromNetwork(data.NetworkSettings);\n      return data;\n    });\n  }\n\n  static parsePorts(ports) {\n    return _.reduce(ports, (ports, port) => {\n      ports[port.PrivatePort] = {\n        name: port.PrivatePort,\n        protocol: port.Type,\n        gateway: port.IP,\n        port: port.PublicPort,\n      }\n      return ports;\n    }, {});\n  }\n\n  static parsePortsFromNetwork(network) {\n    network.Access = {};\n    _.each(network.Ports, (port, name) => {\n      name = name.match(/(\\d*)\\/(.*)/);\n      if (port) {\n        network.Access[name[1]] = {\n          name    : name[1],\n          protocol: name[2],\n          gateway : network.Gateway,\n          port    : port[0].HostPort,\n        };\n      }\n    });\n    return network;\n  }\n\n  static parseStatus(status) {\n    var state = {\n      ExitCode: 0,\n      Paused:  (status.match(/^Up.*\\(Paused\\)$/)) ? true : false,\n      Running: (status.match(/^Up/)) ? true : false\n    }\n\n    // Exited? Get return code\n    if (status.match(/Exited/)) {\n      state.ExitCode = parseInt(\n        status.replace(/Exited \\((.*)\\).*/, \"$1\")\n      );\n    }\n\n    return state;\n  }\n\n  // Serialize annotations to a container name format\n  static serializeAnnotations(annotations = { azk: {} }) {\n    var azk = annotations.azk;\n\n    // Unique id generator\n    if (!azk.uid) {\n      azk.uid = uuid.v1().replace(/-/g, \"\").slice(0, 10);\n    }\n\n    // Mount string\n    return [config('docker:namespace'), ...(_.map(azk, (value, key) => {\n      return key + \".\" + value;\n    }))].join(\"_\");\n  }\n\n  // Unserialize annotations from a container name\n  static unserializeAnnotations(name) {\n    name = name.replace(/\\/(.*)/, \"$1\");\n    var data = name.split('_');\n    return _.reduce(data, (annotations, values) => {\n      var key_value = values.split(\".\");\n      annotations.azk[key_value[0]] = key_value[1];\n      return annotations;\n    }, { azk: {} });\n  }\n\n  static envsFromAnnotations(annotations = { azk: {}}) {\n    return _.reduce(annotations.azk, (envs, value, key) => {\n      if (key == 'azk') key = \"env\";\n      envs[`AZK_${key.toUpperCase()}`] = value;\n      return envs;\n    }, {});\n  }\n}\n\nexport class Docker extends Utils.qify('dockerode') {\n  constructor(opts) {\n    log.info(\"Connect %s:%s\", opts.host, opts.port);\n    super(opts);\n\n    this.c_regex = RegExp(`\\/${Utils.escapeRegExp(config('docker:namespace'))}`);\n  }\n\n  getImage(name) {\n    return new Image(this.modem, name);\n  }\n\n  getContainer(id) {\n    return new Container(this.modem, id);\n  }\n\n  __findObj(obj) {\n    return obj.inspect().then(\n      (_data) => { return obj; },\n      (err  ) => {\n        if (err.statusCode == 404)\n          return null;\n        throw err;\n      }\n    );\n  }\n\n  azkListContainers(...args) {\n    return this.listContainers(...args).then((containers) => {\n      return _.reduce(containers, (result, container) => {\n        if (container.Names[0].match(this.c_regex)) {\n          container.Name = container.Names[0];\n          container.Annotations = Container.unserializeAnnotations(container.Name);\n          container.State = Container.parseStatus(container.Status);\n          container.NetworkSettings = { Access: Container.parsePorts(container.Ports) };\n          result.push(container);\n        }\n        return result;\n      }, []);\n    });\n  }\n\n  findImage(name) {\n    return this.__findObj(this.getImage(name));\n  }\n\n  findContainer(id) {\n    return this.__findObj(this.getContainer(id));\n  }\n\n  pull(...args) {\n    return pull(this, ...args);\n  }\n\n  run(...args) {\n    return run(this, Container, ...args);\n  }\n}\n","var __moduleName = $__placeholder__0;","require($__placeholder__0)","var $__placeholder__0 = $__placeholder__1","$traceurRuntime.defaultSuperCall(this,\n                $__placeholder__0.prototype, arguments)","var $__placeholder__0 = $__placeholder__1","($traceurRuntime.createClass)($__placeholder__0, $__placeholder__1, $__placeholder__2,\n                                       $__placeholder__3)","\n            for (var $__placeholder__0 = [], $__placeholder__1 = 0;\n                 $__placeholder__2 < arguments.length; $__placeholder__3++)\n              $__placeholder__4[$__placeholder__5] = arguments[$__placeholder__6];","$traceurRuntime.toObject($__placeholder__0)","$traceurRuntime.superCall($__placeholder__0, $__placeholder__1, $__placeholder__2,\n                                   $__placeholder__3)","$traceurRuntime.spread($__placeholder__0)","module.exports = $__placeholder__0;","get $__placeholder__0() { return $__placeholder__1; }","__esModule: true"]}