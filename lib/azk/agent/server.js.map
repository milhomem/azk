{"version":3,"file":"server.js","sources":["../../../src/agent/server.js","@traceur/generated/TemplateParser/4","@traceur/generated/TemplateParser/0","@traceur/generated/TemplateParser/12","@traceur/generated/TemplateParser/6","@traceur/generated/TemplateParser/11","@traceur/generated/TemplateParser/8","@traceur/generated/TemplateParser/9","@traceur/generated/TemplateParser/7","@traceur/generated/TemplateParser/10","@traceur/generated/TemplateParser/13","@traceur/generated/TemplateParser/5","@traceur/generated/TemplateParser/1","@traceur/generated/TemplateParser/2"],"names":[],"mappings":"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","sourcesContent":["import { config, defer, async, t, log } from 'azk';\nimport { VM  }   from 'azk/agent/vm';\nimport { Unfsd } from 'azk/agent/unfsd';\nimport { Balancer } from 'azk/agent/balancer';\nimport { net as net_utils } from 'azk/utils';\nimport { AgentStartError } from 'azk/utils/errors';\n\nvar Server = {\n  server: null,\n\n  // TODO: log start machine steps\n  start() {\n    return async(this, function* () {\n      log.info_t(\"commands.agent.starting\");\n\n      // Virtual machine is required?\n      if (config('agent:requires_vm')) {\n        yield this.installShare();\n        yield this.installVM(true);\n        yield this.mountShare();\n      }\n\n      // Load balancer\n      yield this.installBalancer();\n\n      log.info_t(\"commands.agent.started\");\n    });\n  },\n\n  stop() {\n    return async(this, function* () {\n      yield this.removeBalancer();\n      if (config('agent:requires_vm')) {\n        yield this.stopVM();\n        yield this.removeShare();\n      }\n    });\n  },\n\n  installBalancer() {\n    return Balancer.start();\n  },\n\n  removeBalancer() {\n    return Balancer.stop();\n  },\n\n  installShare() {\n    return Unfsd.start();\n  },\n\n  removeShare() {\n    return Unfsd.stop();\n  },\n\n  mountShare() {\n    return Unfsd.mount(config(\"agent:vm:name\"));\n  },\n\n  installVM(start = false) {\n    var vm_name = config(\"agent:vm:name\");\n    return async(this, function* (notify) {\n      var installed = yield VM.isInstalled(vm_name);\n      var running   = (installed) ? yield VM.isRunnig(vm_name) : false;\n\n      if (!installed) {\n        var opts = {\n          name: vm_name,\n          ip  : config(\"agent:vm:ip\"),\n          boot: config(\"agent:vm:boot_disk\"),\n          data: config(\"agent:vm:data_disk\"),\n        }\n\n        yield VM.init(opts);\n      }\n\n      if (!running && start) {\n        yield VM.start(vm_name);\n\n        // Wait for vm start\n        var n = (status) => notify({ type: \"status\", context: \"vm\", status });\n        n(\"wait\");\n        var address = `tcp://${config(\"agent:vm:ip\")}:22`;\n        var success = yield net_utils.waitService(address, 10, { context: \"vm\" });\n        if (!success) {\n          throw new AgentStartError(t(\"errors.not_vm_start\"));\n        }\n        n(\"initialized\");\n\n        // Upload key\n        n(\"upkey\");\n        var key = config('agent:vm:ssh_key') + '.pub';\n        var authoried = config('agent:vm:authorized_key');\n        yield VM.copyFile(vm_name, key, authoried);\n      };\n    });\n  },\n\n  stopVM(running) {\n    var vm_name = config(\"agent:vm:name\");\n    return async(function* () {\n      running = (running == null) ? (yield VM.isRunnig(vm_name)) : false;\n      if (running) {\n        yield VM.stop(vm_name);\n      }\n    });\n  },\n}\n\nexport { Server };\n\n","var __moduleName = $__placeholder__0;","require($__placeholder__0)","return $__placeholder__0(\n            $__placeholder__1,\n            this);","$traceurRuntime.generatorWrap","function($ctx) {\n      while (true) $__placeholder__0\n    }","$ctx.state = ($__placeholder__0) ? $__placeholder__1 : $__placeholder__2;\n        break","return $__placeholder__0","$ctx.maybeThrow()","return $ctx.end()","$ctx.sent","module.exports = $__placeholder__0;","get $__placeholder__0() { return $__placeholder__1; }","__esModule: true"]}