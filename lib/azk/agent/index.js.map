{"version":3,"file":"index.js","sources":["../../../src/agent/index.js","@traceur/generated/TemplateParser/4","@traceur/generated/TemplateParser/0","@traceur/generated/TemplateParser/5","@traceur/generated/TemplateParser/1","@traceur/generated/TemplateParser/2"],"names":[],"mappings":"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","sourcesContent":["import { Q, config, defer, log, _ } from 'azk';\nimport { Pid } from 'azk/utils/pid';\nimport { AgentStartError } from 'azk/utils/errors';\n\nfunction Server() {\n  return require('azk/agent/server').Server;\n}\n\nvar Agent = {\n  wait: null,\n\n  wait_notify(status) {\n    if (typeof(process.send) === 'function') {\n      try {\n        process.send(status);\n      } catch (err) { }\n    }\n  },\n\n  change_status(status, data = null) {\n    this.wait_notify({ type: \"status\", status, pid: process.pid, data: data });\n  },\n\n  start(options) {\n    var pid = this.agentPid();\n    return defer((resolve, reject, notify) => {\n      this.wait_notify = notify;\n\n      if (pid.running) {\n        this.change_status('already');\n        resolve(1);\n      } else {\n        this.change_status('starting');\n        if (options.daemon) {\n          return this.launchDaemon();\n        } else {\n          this.wait = resolve;\n          this.processWrapper().progress(notify).fail((err) => {\n            this.change_status(\"error\", err.stack || err);\n            return this.stop().progress(notify).then(() => {\n              return 0;\n            });\n          });\n        }\n      }\n    });\n  },\n\n  stop(opts) {\n    var pid = this.agentPid();\n    return defer((resolve, reject, notify) => {\n      if (this.wait) {\n        this.change_status(\"stoping\");\n\n        return Server().stop().progress(notify).then(() => {\n          try { pid.unlink(); } catch(e) {}\n          this.change_status(\"stoped\");\n          this.wait(0);\n          resolve(0);\n        }).fail((error) => {\n          try { pid.unlink(); } catch(e) {}\n          this.change_status(\"error\", error.stack || error);\n          this.wait(1);\n          reject(1);\n        });\n      }\n\n      // Stop by signal\n      if (pid.running) pid.term();\n\n      return resolve();\n    });\n  },\n\n  agentPid() {\n    log.info('get agent status');\n    var a_pid = new Pid(config(\"paths:agent_pid\"));\n    log.info('agent is running: %s', a_pid.running);\n    return a_pid;\n  },\n\n  processStateHandler() {\n    var pid = this.agentPid();\n    var stoping = false;\n    var gracefullExit = () => {\n      if (!stoping) {\n        stoping = true;\n        log.info('Azk agent has been killed by signal');\n        return this.stop({}, true);\n      }\n    }\n\n    try {\n      pid.update(process.pid);\n    } catch(e){}\n\n    process.on('SIGTERM', gracefullExit);\n    process.on('SIGINT' , gracefullExit);\n    process.on('SIGQUIT', gracefullExit);\n  },\n\n  processWrapper() {\n    process.title = 'azk-agent';\n    return defer((resolve, reject, notify) => {\n      this.processStateHandler();\n      return Server().start().then(() => {\n        this.change_status(\"started\");\n      });\n    });\n  },\n\n  launchDaemon() {\n    return defer((done) => {\n      var child_process = require('child_process');\n\n      log.debug(\"Launching agent in daemon mode\");\n      var child = child_process.fork(__filename, [], {\n        silent  : true,\n        detached: true,\n        cwd     : config('paths:azk_root'),\n        env     : _.extend({\n        }, process.env),\n      }, (err, stdout, stderr) => {\n        if (err) done.reject(err.stack);\n      });\n\n      var exit = () => {\n        done.resolve(1);\n      }\n\n      var msg_cb = (msg) => {\n        log.debug('agent child msg: %s', msg);\n        this.change_status(msg.status, msg.data);\n        if (msg.status == \"started\") {\n          child.removeListener('exit', exit);\n          child.removeListener('message', msg_cb);\n          child.unref();\n          return done.resolve(0);\n        }\n      };\n\n      child.on('exit', exit);\n      child.on('message', msg_cb);\n    });\n  },\n}\n\nexport { Agent };\n\n//\n// If this file is a main process, it means that\n// this process is being forked by azk itself\nif (require.main === module) {\n  Agent.wait = function(code) {\n    process.exit(code);\n  }\n\n  Agent.processWrapper().fail((error) => {\n    Agent.change_status(\"error\", error.toString());\n    return Agent.stop()\n  });\n}\n","var __moduleName = $__placeholder__0;","require($__placeholder__0)","module.exports = $__placeholder__0;","get $__placeholder__0() { return $__placeholder__1; }","__esModule: true"]}