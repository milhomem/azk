{"version":3,"file":"logs.js","sources":["../../../src/cmds/logs.js","@traceur/generated/TemplateParser/4","@traceur/generated/TemplateParser/0","@traceur/generated/TemplateParser/7","@traceur/generated/TemplateParser/6","@traceur/generated/TemplateParser/9","@traceur/generated/TemplateParser/8","@traceur/generated/TemplateParser/15","@traceur/generated/TemplateParser/10","@traceur/generated/TemplateParser/14","@traceur/generated/TemplateParser/12","@traceur/generated/TemplateParser/11","@traceur/generated/TemplateParser/13","@traceur/generated/TemplateParser/5","@traceur/generated/TemplateParser/1","@traceur/generated/TemplateParser/2"],"names":[],"mappings":"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","sourcesContent":["import { log, _, async, defer, config, Q, t } from 'azk';\nimport { Command, Helpers } from 'azk/cli/command';\nimport { Manifest } from 'azk/manifest';\nimport { ReadableStream } from 'memory-streams';\nimport docker from 'azk/docker';\n\nvar moment  = require('moment');\n\nclass Cmd extends Command {\n  action(opts) {\n    return async(this, function* () {\n      yield Helpers.requireAgent();\n\n      var manifest = new Manifest(this.cwd, true);\n      var systems  = manifest.getSystemsByName(opts.system);\n\n      yield this.logs(manifest, systems, opts);\n    });\n  }\n\n  make_out(output, name) {\n    return {\n      write(buffer) {\n        var data = buffer.toString().match(/^\\[(.*?)\\](.*\\n)$/m);\n        if (data) {\n          output.write(`${data[1].magenta} ${name}:${data[2]}`);\n        } else {\n          output.write(`${name} `);\n          output.write(buffer);\n        }\n      }\n    }\n  }\n\n  connect(system, color, instances, options) {\n    return _.map(instances, (instance) => {\n      var name = `${system.name}${instance.Annotations.azk.seq}`[color];\n      var container = docker.getContainer(instance.Id);\n      var stdout = this.make_out(process.stdout, name);\n      var stderr = this.make_out(process.stderr, name);\n\n      return container.logs(options).then((stream) => {\n        return defer((resolve, reject) => {\n          //if (_.isString(stream)) {\n            //stream = new ReadableStream(new Buffer(stream));\n          //}\n          container.modem.demuxStream(stream, stdout, stderr);\n          stream.on('end', resolve);\n        });\n      });\n    });\n  }\n\n  logs(manifest, systems, opts = {}) {\n    var options = {\n      stdout: true,\n      stderr: true,\n      tail: opts.lines,\n      timestamps: opts.timestamps,\n    };\n\n    if (opts.follow) {\n      options.follow = true;\n    }\n\n    var colors = [\"green\", \"yellow\", \"blue\", \"red\", \"cyan\", \"grey\"];\n    var color  = -1;\n\n    return Q.all(_.map(systems, (system) => {\n      return system.instances({ type: \"daemon\" }).then((instances) => {\n        color++;\n\n        if (opts.instances) {\n          opts.instances = opts.instances.split(',');\n          instances = _.filter(instances, (instance) => {\n            return _.contains(opts.instances, instance.Annotations.azk.seq);\n          });\n        }\n\n        return Q.all(this.connect(system, colors[color % colors.length], instances, options));\n      });\n    }));\n  }\n}\n\nexport { Cmd };\nexport function init(cli) {\n  (new Cmd('logs [system] [instances]', cli))\n    .addOption(['--follow', '--tail', '-f'], { default: false })\n    .addOption(['--lines', '-n'], { type: Number, default: \"all\" })\n    .addOption(['--timestamps'], { default: true });\n}\n\n","var __moduleName = $__placeholder__0;","require($__placeholder__0)","var $__placeholder__0 = $__placeholder__1","$traceurRuntime.defaultSuperCall(this,\n                $__placeholder__0.prototype, arguments)","var $__placeholder__0 = $__placeholder__1","($traceurRuntime.createClass)($__placeholder__0, $__placeholder__1, $__placeholder__2,\n                                       $__placeholder__3)","return $__placeholder__0(\n            $__placeholder__1,\n            this);","$traceurRuntime.generatorWrap","function($ctx) {\n      while (true) $__placeholder__0\n    }","return $__placeholder__0","$ctx.maybeThrow()","return $ctx.end()","module.exports = $__placeholder__0;","get $__placeholder__0() { return $__placeholder__1; }","__esModule: true"]}