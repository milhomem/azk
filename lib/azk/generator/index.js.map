{"version":3,"file":"index.js","sources":["../../../src/generator/index.js","@traceur/generated/TemplateParser/4","@traceur/generated/TemplateParser/0","@traceur/generated/TemplateParser/7","@traceur/generated/TemplateParser/6","@traceur/generated/TemplateParser/9","@traceur/generated/TemplateParser/8","@traceur/generated/TemplateParser/10","@traceur/generated/TemplateParser/5","@traceur/generated/TemplateParser/1","@traceur/generated/TemplateParser/2"],"names":[],"mappings":"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","sourcesContent":["import { _, config, log } from 'azk';\nimport { Helpers, example_system } from 'azk/generator/rules';\nimport { UIProxy } from 'azk/cli/ui';\n\nvar glob = require('glob');\nvar path = require('path');\nvar fs   = require('fs');\nvar Handlebars = require('handlebars');\n\nvar template = path.join(\n  config('paths:azk_root'), 'src', 'share', 'Azkfile.mustache.js'\n);\n\nexport class Generator extends UIProxy {\n  constructor(ui) {\n    super(ui);\n\n    this.__rules = {\n      runtime  : [],\n      database : [],\n      tasks    : [],\n    }\n\n    // Load default rules\n    this.load(path.join(__dirname, \"rules\"));\n  }\n\n  get rules() {\n    return [...this.__rules.runtime, ...this.__rules.database, ...this.__rules.tasks];\n  }\n\n  get tpl() {\n    if (!this._tpl)\n      this._tpl = Handlebars.compile(fs.readFileSync(template).toString());\n    return this._tpl;\n  }\n\n  load(dir) {\n    _.each(glob.sync(path.join(dir, '**/*.js')), (file) => {\n      var Rule = require(file).Rule;\n      if (Rule) {\n        var rule = new Rule(this);\n        if (_.isArray(this.__rules[rule.type])) {\n          rule.name = path.basename(file, \".js\");\n          this.__rules[rule.type].push(rule);\n        }\n      }\n    });\n  }\n\n  rule(name) {\n    return _.find(this.rules, (rule) => { return rule.name == name });\n  }\n\n  findSystems(dir) {\n    return _.reduce(this.rules, (systems, rule) => {\n      return _.merge(systems, rule.run(dir, systems) || {});\n    }, {});\n  }\n\n  render(data, file) {\n    data = _.extend({\n      bins: [],\n      azk: {\n        default_domain: config('agent:balancer:host')\n      },\n    }, data);\n    fs.writeFileSync(file, this.tpl(data));\n  }\n}\n\nfunction json(data) {\n  return JSON.stringify(data || null, null, ' ')\n    .replace(/\\n/g, '')\n    .replace(/^(\\{|\\[) /, '$1');\n}\n\nfunction hash_key(data) {\n  return (data || \"\").match(/^[\\w|_]*$/) ? data : `'${data}'`;\n}\n\nfunction mount(data) {\n  if (_.isString(data)) { return json(data); }\n  var type    = data.type;\n  var options = _.reduce(data, (opts, value, key) => {\n    if (key != 'value' && key != 'type') {\n      opts[key] = value;\n    }\n    return opts;\n  }, {});\n\n  // args\n  var args  = [];\n  if (!_.isUndefined(data.value)) { args.push(data.value) };\n  if (!_.isEmpty(options)) args.push(options);\n  args = _.map(args, (arg) => { return json(arg); });\n\n  switch(data.type) {\n    default:\n      return `${data.type}(${args.join(', ')})`;\n  }\n}\n\nHandlebars.registerHelper('json', json);\nHandlebars.registerHelper('hash_key', hash_key);\nHandlebars.registerHelper('mount', mount);\n\nexport { example_system };\n\n","var __moduleName = $__placeholder__0;","require($__placeholder__0)","var $__placeholder__0 = $__placeholder__1","$traceurRuntime.superCall($__placeholder__0, $__placeholder__1, $__placeholder__2,\n                                   $__placeholder__3)","var $__placeholder__0 = $__placeholder__1","($traceurRuntime.createClass)($__placeholder__0, $__placeholder__1, $__placeholder__2,\n                                       $__placeholder__3)","$traceurRuntime.spread($__placeholder__0)","module.exports = $__placeholder__0;","get $__placeholder__0() { return $__placeholder__1; }","__esModule: true"]}